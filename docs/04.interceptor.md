---
title: カスタムのインターセプタを HAPI JPA Server に組み込む
tags:
  - hapi
  - fhir
private: false
updated_at: '2024-07-06T18:00:00+09:00'
id: null
organization_url_name: null
slide: false
ignorePublish: false
---

次はカスタムのインターセプタを HAPI JPA Server に組み込んでみます。

# インターセプタとは

HAPI がデータの登録など、何かをしようとした時に実行されるのがインターセプタということらしいです。

<https://hapifhir.io/hapi-fhir/docs/interceptors/interceptors.html>

HAPI FHIR 3.8.0 から新しいフレームワークが導入されたらしく、クライアントとサーバーどちらでも使うことができ、柔軟にイベント処理のようなものを追加することができるとありました。

# カスタムのインターセプタクラスを作成する

以下ドキュメントを見る限りでは、カスタムインターセプタを含むパッケージとクラス名を設定に追加して読み込ませるようです。

<https://github.com/hapifhir/hapi-fhir-jpaserver-starter>

ではカスタムのインターセプタを定義するための Maven プロジェクトを作っていきます。

## Java 開発環境

[IntelliJ IDEA](https://www.jetbrains.com/idea/) を使って作るのが一般的なのだと思うのですが、ここでそれをインストールして使うのも面倒なので、ここでは [sdkman](https://sdkman.io/) を使ってサクッと Java + Maven の開発環境を整えました。

インストール方法などは詳しく説明しませんが、以下のページにやり方が書いてあります。

* インストール方法 : <https://sdkman.io/install>
* 使い方 : <https://sdkman.io/usage>

以下のような環境でやっていきます。

```text
$ sdk version

SDKMAN!
script: 5.18.2
native: 0.4.3

$ sdk current

Using:

java: 21.0.1-open
maven: 3.9.5
```

## プロジェクトの作成

以下のような Maven コマンドでプロジェクトを作成します。

```bash
mvn archetype:generate \
  -DarchetypeArtifactId=maven-archetype-quickstart \
  -DinteractiveMode=false \
  -DgroupId=com.example.fhir.hapi \
  -DartifactId=my-interceptors
```

すると `my-interceptors` というディレクトリが作成されて、その中に Maven プロジェクトが作成されます。不要なファイルが Git 管理されないよう Maven でよく使用される [gitignore](https://github.com/github/gitignore/blob/main/Maven.gitignore) の設定をダウンロードしてきて `my-interceptors` 内にあらかじめ置いておきましょう。

## 依存関係の追加

ドキュメントで例示されている `YourInterceptor` クラスは、以下のパッケージを使っていました。

* `org.hl7.fhir.instance.model.api`
* `org.springframework.stereotype`
* `ca.uhn.fhir.interceptor.api`

それぞれのパッケージが含まれる Maven の Group ID と Artifact ID を知りたかったのですが、調べても明確には分かりませんでした。おそらく以下の二つで十分なのだろうと思うので `pom.xml` の依存関係に二つを追加していきます。

* [HAPI FHIR Core Library](https://mvnrepository.com/artifact/ca.uhn.hapi.fhir/hapi-fhir-base)
* [Spring Context](https://mvnrepository.com/artifact/org.springframework/spring-context)

`pom.xml` の変更差分がこちらです。

```diff
    </dependency>

+   <!-- https://mvnrepository.com/artifact/ca.uhn.hapi.fhir/hapi-fhir-base -->
+   <dependency>
+     <groupId>ca.uhn.hapi.fhir</groupId>
+     <artifactId>hapi-fhir-base</artifactId>
+     <version>7.2.1</version>
+   </dependency>
+
+   <!-- https://mvnrepository.com/artifact/org.springframework/spring-context -->
+   <dependency>
+     <groupId>org.springframework</groupId>
+     <artifactId>spring-context</artifactId>
+     <version>6.1.10</version>
+   </dependency>
  </dependencies>
</project>
```

## クラス作成

プロジェクトの準備もできたので、ドキュメントを参考に以下のようなインターセプタのクラスを作成しました。作成したクラスは `my-interceptors/src/main/java/com/example/fhir/hapi/MyInterceptor.java` ファイルとしてプロジェクト内に追加しています。

```java
package com.example.fhir.hapi;

import org.hl7.fhir.instance.model.api.IBaseResource;
import org.springframework.stereotype.Component;

import ca.uhn.fhir.interceptor.api.Hook;
import ca.uhn.fhir.interceptor.api.Interceptor;
import ca.uhn.fhir.interceptor.api.Pointcut;

@Component
@Interceptor
public class MyInterceptor {
    @Hook(Pointcut.STORAGE_PRECOMMIT_RESOURCE_CREATED)
    public void resourceCreated(IBaseResource newResource) {
        System.out.println("MyInterceptor.resourceCreated");
    }
}
```

このインターセプタを登録すれば、リソースが作成される前に `MyInterceptor.resourceCreated` という文字列が標準出力されるはずです。

## コンパイル

プロジェクトをコンパイルしてクラスファイルを作成します。以下のコマンドを `my-interceptors` ディレクトリで実行すると `my-interceptors/target` ディレクトリにコンパイルした内容が出力されます。

```bash
mvn compile
```
